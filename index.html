<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Export Viewer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-theme-dark">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme-light" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <!-- JSZip for reading zip files (loaded in worker) -->
    <style>
        /* --- Base & Scrollbar --- */
        :root {
            --bg-color-dark: #0c0a09;
            --bg-image-dark:
                radial-gradient(at 0% 0%, hsla(253, 100%, 70%, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 100%, 70%, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(212, 100%, 70%, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(135, 100%, 70%, 0.15) 0px, transparent 50%);
            --text-color-dark: #e7e5e4; /* stone-200 */

            --bg-color-light: #f5f5f4; /* stone-100 */
             --bg-image-light:
                radial-gradient(at 0% 0%, hsla(253, 100%, 80%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 100%, 80%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(212, 100%, 80%, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(135, 100%, 80%, 0.1) 0px, transparent 50%);
            --text-color-light: #292524; /* stone-800 */
        }
        body {
            background-color: var(--bg-color-dark);
            background-image: var(--bg-image-dark);
            color: var(--text-color-dark);
        }
        body.light {
            background-color: var(--bg-color-light);
            background-image: var(--bg-image-light);
            color: var(--text-color-light);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.1); }
        body.light ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
        body.light ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.3); }

        /* --- Authentic Glassmorphism Effect --- */
        .glass {
            background: rgba(28, 28, 30, 0.5);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        body.light .glass {
             background: rgba(255, 255, 255, 0.5);
             border: 1px solid rgba(0, 0, 0, 0.1);
             box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        /* --- Prose (Markdown Content) Styles --- */
        .prose pre { background-color: rgba(17, 24, 39, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); color: #d1d5db; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        body.light .prose pre { background-color: #f3f4f6; border-color: #d1d5db; color: #1f2937; }
        .prose code { font-family: 'Courier New', Courier, monospace; }
        .prose p { margin-top: 0; margin-bottom: 1em; }
        .prose img { max-width: 100%; border-radius: 0.5rem; margin-top: 1em; margin-bottom: 1em; }
        .prose mark, .search-highlight { background-color: #facc15; color: #1f2937; padding: 0.1rem 0.2rem; border-radius: 0.2rem; }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 120px; background-color: #111827; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
        body.light .tooltip .tooltiptext { background-color: #f3f4f6; color: #111827; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        .loader-spinner { border-top-color: #6366f1; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .transition-all { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-stone-950 text-gray-200 font-sans antialiased">

    <!-- Web Worker Script -->
    <script id="worker" type="javascript/worker">
        self.importScripts(
            'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
            'https://unpkg.com/dexie/dist/dexie.js'
        );

        // Worker-side Dexie instance
        const db = new Dexie('UniversalChatArchive');
        db.version(1).stores({
            conversations: '++id, platform, title, create_time',
            messages: 'id, conversationId, timestamp',
            media: 'id',
        });
        db.version(2).stores({
            messages: 'id, conversationId, timestamp, *searchText'
        }).upgrade(tx => {
            // Upgrade script to populate the new searchText field for existing messages
            // This is good practice but for this case, we'll assume users re-import.
            // A more robust solution would iterate and update here.
        });

        const flattenMessages = (mapping) => {
            if (!mapping || Object.keys(mapping).length === 0) return [];
            let leafNodeId = null;
            let maxCreateTime = 0;
            for (const id in mapping) {
                const node = mapping[id];
                if (node.message && node.message.create_time && node.message.create_time > maxCreateTime) {
                    maxCreateTime = node.message.create_time;
                    leafNodeId = id;
                }
            }
            if (!leafNodeId) return [];
            const reversedMessages = [];
            let currentId = leafNodeId;
            while (currentId) {
                const node = mapping[currentId];
                if (node && node.message) reversedMessages.push(node.message);
                currentId = node ? node.parent : null;
            }
            return reversedMessages.reverse();
        };

        const extractJsonData = (htmlContent) => {
            const jsonVarStart = 'var jsonData = ';
            const startIndex = htmlContent.indexOf(jsonVarStart);
            if (startIndex === -1) throw new Error("Could not find conversation data variable in chat.html.");
            const scriptContent = htmlContent.substring(startIndex + jsonVarStart.length);
            let bracketCount = 0, inString = false, jsonEndIndex = -1, firstBracketFound = false;
            for (let i = 0; i < scriptContent.length; i++) {
                const char = scriptContent[i];
                if (char === '"' && (i === 0 || scriptContent[i - 1] !== '\\')) inString = !inString;
                if (!inString) {
                    if (char === '[') { if (!firstBracketFound) firstBracketFound = true; bracketCount++; }
                    else if (char === ']') { bracketCount--; }
                }
                if (firstBracketFound && bracketCount === 0) { jsonEndIndex = i; break; }
            }
            if (jsonEndIndex === -1) throw new Error("Could not parse conversation data array.");
            const jsonString = scriptContent.substring(0, jsonEndIndex + 1).trim();
            return JSON.parse(jsonString);
        };

        const parseChatGPT = async (file) => {
            self.postMessage({ type: 'progress', message: 'Unzipping archive...' });
            const zip = await self.JSZip.loadAsync(file);
            const chatHtmlFile = zip.file('chat.html');
            if (!chatHtmlFile) throw new Error("The zip file does not contain 'chat.html'.");

            self.postMessage({ type: 'progress', message: 'Processing images...' });
            const imageFolder = zip.folder("images");
            if (imageFolder) {
                const mediaPromises = [];
                imageFolder.forEach((relativePath, file) => {
                    if (!file.dir) {
                        const promise = file.async('blob').then(blob => ({ id: `images/${relativePath}`, blob }));
                        mediaPromises.push(promise);
                    }
                });
                const mediaItems = await Promise.all(mediaPromises);
                if (mediaItems.length > 0) await db.media.bulkPut(mediaItems);
            }

            self.postMessage({ type: 'progress', message: 'Parsing conversations...' });
            const htmlContent = await chatHtmlFile.async('string');
            const conversationsData = extractJsonData(htmlContent);
            if (!conversationsData || conversationsData.length === 0) throw new Error('No conversations found.');

            self.postMessage({ type: 'progress', message: `Found ${conversationsData.length} conversations. Storing...` });
            for (const convo of conversationsData) {
                if (!convo.title) continue;
                const conversationId = await db.conversations.add({
                    platform: 'chatgpt',
                    title: convo.title,
                    create_time: convo.create_time,
                    update_time: convo.update_time,
                });
                const messages = flattenMessages(convo.mapping)
                    .filter(msg => msg && msg.author.role !== 'system' && (msg.content?.parts || msg.content?.text))
                    .map(msg => {
                        const contentParts = [];
                        const textForSearch = [];
                        const parts = msg.content.parts || (msg.content.text ? [msg.content.text] : []);

                        parts.forEach(part => {
                            if (typeof part === 'string' && part.trim()) {
                                contentParts.push({ type: 'text', value: part });
                                textForSearch.push(part);
                            } else if (typeof part === 'object' && part) {
                                if (part.asset_pointer && part.content_type === 'image_asset_pointer') {
                                    let imagePath = part.file_path;
                                    if (imagePath && !imagePath.startsWith('images/')) imagePath = `images/${imagePath}`;
                                    contentParts.push({ type: 'image', mediaId: imagePath });
                                } else if (part.text && part.text.trim()) {
                                    contentParts.push({ type: 'text', value: part.text });
                                    textForSearch.push(part.text);
                                }
                            }
                        });

                        return {
                            id: msg.id,
                            conversationId,
                            timestamp: msg.create_time,
                            author: msg.author.role,
                            content: contentParts,
                            searchText: textForSearch.join(' '),
                            metadata: { end_turn: msg.end_turn, weight: msg.weight, metadata: msg.metadata }
                        };
                    })
                    .filter(msg => msg.content.length > 0);
                if (messages.length > 0) await db.messages.bulkAdd(messages);
            }
        };

        self.onmessage = async (e) => {
            const { file, platform } = e.data;
            try {
                if (platform === 'chatgpt') {
                    await parseChatGPT(file);
                } else {
                    // Stubs for other parsers
                    throw new Error(`Parser for platform '${platform}' is not implemented yet.`);
                }
                self.postMessage({ type: 'done' });
            } catch (error) {
                self.postMessage({ type: 'error', message: `${error.message}` });
            }
        };
    </script>

    <!-- Modals -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="glass p-6 w-full max-w-sm text-center flex items-center gap-4">
            <div class="loader-spinner h-8 w-8 rounded-full border-4 border-gray-500"></div>
            <div>
                <h3 class="text-lg font-bold text-inherit">Processing File...</h3>
                <p id="loading-message" class="text-inherit opacity-75 mt-1">Please wait.</p>
            </div>
        </div>
    </div>
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="glass p-6 w-full max-w-md text-center">
            <h3 class="text-xl font-bold text-red-400">Error</h3>
            <p id="error-message" class="text-inherit opacity-90 mt-2 mb-4">An unexpected error occurred.</p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="flex h-screen p-4 gap-4">

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 md:w-80 flex-shrink-0 flex flex-col glass transition-all">
            <div class="p-4 flex flex-col h-full">
                <header class="mb-4 flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-inherit">ChatGPT Viewer</h1>
                        <p class="text-sm text-inherit opacity-60">View & Search Exports</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="tooltip">
                            <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 transition-all">
                                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-inherit" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-inherit hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                            </button>
                             <span class="tooltiptext">Toggle Theme</span>
                        </div>
                    </div>
                </header>

                <div class="mb-4 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-inherit opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                    <input type="text" id="universal-search-input" placeholder="Search all..." class="w-full bg-black/20 border border-white/10 rounded-lg py-2 pl-10 pr-4 text-inherit focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder:text-inherit placeholder:opacity-50">
                </div>

                <div class="overflow-y-auto flex-grow relative">
                    <nav id="conversation-list" class="absolute inset-0"></nav>
                    <div id="universal-search-results" class="absolute inset-0 hidden"></div>
                </div>

                <footer class="mt-4 pt-4 border-t border-white/10">
                     <div class="flex items-center justify-center gap-4">
                        <div class="tooltip">
                            <label for="file-upload" class="cursor-pointer p-3 rounded-full bg-black/20 hover:bg-indigo-500 text-gray-300 hover:text-white transition-all transform hover:scale-110 block">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                            </label>
                            <span class="tooltiptext">Upload Export</span>
                        </div>
                        <div class="tooltip">
                            <button id="export-json-btn" class="p-3 rounded-full bg-black/20 hover:bg-indigo-500 text-gray-300 hover:text-white transition-all transform hover:scale-110">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                            <span class="tooltiptext">Export JSON</span>
                        </div>
                         <div class="tooltip">
                            <button id="clear-data-btn" class="p-3 rounded-full bg-black/20 hover:bg-red-500 text-gray-300 hover:text-white transition-all transform hover:scale-110">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 00-2.09 2.134v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                            <span class="tooltiptext">Clear Data</span>
                        </div>
                     </div>
                     <input id="file-upload" type="file" class="hidden" accept=".zip,.txt,.json">
                </footer>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 flex flex-col overflow-y-hidden glass">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-4 transition-all">
                <div class="p-8 rounded-2xl max-w-lg w-full">
                    <h2 class="text-2xl font-bold text-inherit">Universal Chat Archive</h2>
                    <p class="mt-2 text-inherit opacity-75 mb-6">
                        Import, view, and search your chat history from multiple platforms.
                        All processing is done securely in your browser.
                    </p>

                    <div id="platform-selection">
                        <h3 class="text-lg font-semibold text-inherit mb-3 text-left">1. Select Platform</h3>
                        <div class="flex justify-start gap-4 text-sm">
                            <label class="flex items-center gap-2 p-3 rounded-lg bg-black/20 hover:bg-white/10 cursor-pointer border border-transparent has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-900/50 transition-all">
                                <input type="radio" name="platform" value="chatgpt" class="sr-only" checked>
                                <span>ChatGPT (.zip)</span>
                            </label>
                            <label class="flex items-center gap-2 p-3 rounded-lg bg-black/20 hover:bg-white/10 cursor-pointer border border-transparent has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-900/50 transition-all">
                                <input type="radio" name="platform" value="whatsapp" class="sr-only">
                                <span>WhatsApp (.zip, .txt)</span>
                            </label>
                             <label class="flex items-center gap-2 p-3 rounded-lg bg-black/20 hover:bg-white/10 cursor-pointer border border-transparent has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-900/50 transition-all">
                                <input type="radio" name="platform" value="ucajson" class="sr-only">
                                <span>UCA JSON</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-inherit mb-3 text-left">2. Upload File</h3>
                        <label for="file-upload" class="cursor-pointer block p-6 rounded-lg bg-black/20 hover:bg-white/10 border-2 border-dashed border-white/20 hover:border-indigo-500 transition-all text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mx-auto mb-2 text-inherit opacity-50"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                            <span>Click to upload or drag and drop</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="chat-view" class="hidden h-full flex flex-col">
                 <div class="max-w-4xl w-full mx-auto flex flex-col h-full">
                     <header class="p-4 bg-black/20 flex-shrink-0">
                         <h2 id="chat-title" class="text-2xl font-semibold text-inherit truncate"></h2>
                         <div id="chat-stats" class="text-sm text-inherit opacity-60 mt-1"></div>
                         <div class="relative mt-3">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-inherit opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                            <input type="text" id="search-input" placeholder="Search in this conversation..." class="w-full bg-black/20 border border-white/10 rounded-lg py-2 pl-10 pr-4 text-inherit focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder:text-inherit placeholder:opacity-50">
                         </div>
                         <p id="search-results-info" class="text-sm text-inherit opacity-60 mt-2 h-5"></p>
                     </header>
                     <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                        <div id="message-lazy-load-sentinel" class="h-10"></div>
                     </div>
                 </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATABASE SETUP ---
        const db = new Dexie('UniversalChatArchive');
        db.version(1).stores({
            conversations: '++id, platform, title, create_time',
            messages: 'id, conversationId, timestamp',
            media: 'id',
        });
    </script>
    <script>
        // DOM element references
        const fileUploadInput = document.getElementById('file-upload'), conversationList = document.getElementById('conversation-list'), universalSearchInput = document.getElementById('universal-search-input'), universalSearchResults = document.getElementById('universal-search-results'), welcomeScreen = document.getElementById('welcome-screen'), chatView = document.getElementById('chat-view'), chatTitle = document.getElementById('chat-title'), chatStats = document.getElementById('chat-stats'), messagesContainer = document.getElementById('messages-container'), searchInput = document.getElementById('search-input'), searchResultsInfo = document.getElementById('search-results-info'), errorModal = document.getElementById('error-modal'), errorMessage = document.getElementById('error-message'), exportJsonBtn = document.getElementById('export-json-btn'), loadingModal = document.getElementById('loading-modal'), loadingMessage = document.getElementById('loading-message'), sentinel = document.getElementById('message-lazy-load-sentinel'), themeToggleBtn = document.getElementById('theme-toggle'), clearDataBtn = document.getElementById('clear-data-btn');

        let worker;
        let isProcessing = false;
        let activeConversationId = null;
        let activeObjectURLs = [];
        let welcomeScreenTemplate;

        // --- LAZY LOADING STATE ---
        let currentMessages = [];
        let currentRenderIndex = 0;
        const RENDER_BATCH_SIZE = 20;
        let observer;

        // --- ICONS ---
        const assistantIcon = `<div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center flex-shrink-0 border border-white/20"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></div>`;
        const userIcon = `<div class="w-8 h-8 rounded-lg bg-gray-600 flex items-center justify-center flex-shrink-0 border border-white/20"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></div>`;
        const toolIcon = `<div class="w-6 h-6 rounded-md bg-gray-500 flex items-center justify-center flex-shrink-0 border border-white/20"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L7.86 5.89c-.31.29-.69.46-1.1.51L4.14 6.8c-1.6.15-2.25 2.15-1.05 3.27l1.96 1.85c.25.23.37.58.3.91l-.57 2.65c-.32 1.5.8 2.85 2.2 2.15l2.25-1.12c.33-.17.7-.17 1.03 0l2.25 1.12c1.4.7 2.52-.65 2.2-2.15l-.57-2.65c-.07-.33.05-.68.3-.91l1.96-1.85c1.2-1.12.55-3.12-1.05-3.27l-2.62-.35c-.41-.05-.79-.22-1.1-.51L11.49 3.17z" clip-rule="evenodd" /></svg></div>`;

        // --- INITIALIZATION & THEME ---
        function initializeWorker() {
            try {
                const workerScript = document.getElementById('worker').textContent;
                const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
                worker = new Worker(URL.createObjectURL(workerBlob));

                worker.onmessage = (e) => {
                    const { type, message } = e.data;
                    if (type === 'progress') {
                        loadingMessage.textContent = message;
                    } else if (type === 'error') {
                        showError(message);
                        isProcessing = false;
                        loadingModal.classList.add('hidden');
                    } else if (type === 'done') {
                        // Data is now in the DB, just need to update the UI
                        processLoadedData();
                        loadingModal.classList.add('hidden');
                        isProcessing = false;
                    }
                };
                 worker.onerror = (e) => {
                    showError(`A critical error occurred in the background processor: ${e.message}`);
                    isProcessing = false;
                };
            } catch (e) {
                 showError(`Failed to initialize background processor. Your browser may not be supported. Error: ${e.message}`);
            }
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light');
                document.getElementById('theme-icon-dark').classList.add('hidden');
                document.getElementById('theme-icon-light').classList.remove('hidden');
                document.getElementById('hljs-theme-dark').disabled = true;
                document.getElementById('hljs-theme-light').disabled = false;
            } else {
                document.body.classList.remove('light');
                document.getElementById('theme-icon-dark').classList.remove('hidden');
                document.getElementById('theme-icon-light').classList.add('hidden');
                document.getElementById('hljs-theme-dark').disabled = false;
                document.getElementById('hljs-theme-light').disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeWorker();
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            // Store the initial welcome screen state to restore it later
            const welcomeScreenContent = document.querySelector('#welcome-screen .p-8');
            if (welcomeScreenContent) {
                welcomeScreenTemplate = welcomeScreenContent.cloneNode(true);
            }

            // Add dropzone event listeners
            const dropzone = document.querySelector('label[for="file-upload"]');
            if (dropzone) {
                dropzone.addEventListener('dragenter', (e) => { e.preventDefault(); dropzone.classList.add('border-indigo-500'); });
                dropzone.addEventListener('dragover', (e) => { e.preventDefault(); });
                dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('border-indigo-500'); });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('border-indigo-500');
                    const file = e.dataTransfer.files[0];
                    handleFileSelect(file); // Pass the file object directly
                });
            }
        });

        // --- EVENT LISTENERS ---
        fileUploadInput.addEventListener('change', handleFileSelect);
        searchInput.addEventListener('input', () => performSearch(searchInput.value));
        universalSearchInput.addEventListener('input', () => performUniversalSearch(universalSearchInput.value));
        messagesContainer.addEventListener('click', handleMessageContainerClick);
        exportJsonBtn.addEventListener('click', exportConversationsToJson);
        clearDataBtn.addEventListener('click', clearAllData);
        themeToggleBtn.addEventListener('click', () => {
            const isLight = document.body.classList.toggle('light');
            const newTheme = isLight ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        function showError(message) {
            loadingModal.classList.add('hidden');
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            errorModal.classList.add('flex');
            console.error(message);
        }

        // --- DATA & STATE MANAGEMENT ---
        function handleFileSelect(event) {
            const file = event.target.files ? event.target.files[0] : event;
            if (!file) return;

            if (isProcessing) {
                showError("A file is already being processed. Please wait.");
                return;
            }

            const platform = document.querySelector('input[name="platform"]:checked').value;

            // Basic validation based on platform
            if (platform === 'chatgpt' && !file.name.endsWith('.zip')) {
                showError("Invalid file type for ChatGPT. Please upload the 'export.zip' file.");
                return;
            }
            if (platform === 'whatsapp' && !file.name.endsWith('.zip') && !file.name.endsWith('.txt')) {
                showError("Invalid file type for WhatsApp. Please upload a .zip or .txt file.");
                return;
            }
             if (platform === 'ucajson' && !file.name.endsWith('.json')) {
                showError("Invalid file type for UCA JSON. Please upload a .json file.");
                return;
            }

            isProcessing = true;
            loadingModal.classList.remove('hidden');
            loadingModal.classList.add('flex');
            loadingMessage.textContent = 'Sending file to background processor...';
            worker.postMessage({ file, platform });

            // Reset file input if it exists
            if(event.target && event.target.value) {
                event.target.value = '';
            }
        }

        async function processLoadedData() {
            await renderSidebar();
            const conversationCount = await db.conversations.count();
            if (conversationCount > 0) {
                welcomeScreen.innerHTML = `<div class="p-8 rounded-2xl max-w-md"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h2 class="mt-4 text-2xl font-bold text-inherit">File Loaded!</h2><p class="mt-2 text-inherit opacity-75">Select a conversation from the sidebar to begin.</p></div>`;
                welcomeScreen.classList.remove('hidden');
                chatView.classList.add('hidden');
            }
        }

        async function clearAllData() {
            const confirmation = confirm("Are you sure you want to delete all imported data? This action cannot be undone.");
            if (!confirmation) return;

            await db.delete();
            // Re-initialize the DB after deletion
            db.version(2).stores({
                conversations: '++id, platform, title, create_time',
                messages: 'id, conversationId, timestamp, *searchText',
                media: 'id',
            });
            await db.open();

            activeConversationId = null;
            conversationList.innerHTML = '';
            universalSearchInput.value = '';
            universalSearchResults.innerHTML = '';
            universalSearchResults.classList.add('hidden');
            conversationList.classList.remove('hidden');
            chatView.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');

            // Restore original welcome message from template
            const welcomeScreenContent = document.querySelector('#welcome-screen .p-8');
            if (welcomeScreenContent && welcomeScreenTemplate) {
                welcomeScreenContent.innerHTML = ''; // Clear it first
                welcomeScreenContent.appendChild(welcomeScreenTemplate.cloneNode(true));
            }
        }

        // --- UI RENDERING (DB-DRIVEN) ---
        async function renderSidebar() {
            const conversations = await db.conversations.orderBy('create_time').reverse().toArray();
            conversationList.innerHTML = '';
            conversations.forEach(convo => {
                const convoElement = document.createElement('a');
                convoElement.href = '#';
                convoElement.dataset.id = convo.id;
                convoElement.textContent = convo.title;
                convoElement.className = 'block py-2.5 px-4 rounded-md text-inherit opacity-75 hover:bg-white/10 hover:opacity-100 transition-all duration-200 truncate';
                convoElement.onclick = (e) => { e.preventDefault(); setActiveConversation(convo.id); };
                conversationList.appendChild(convoElement);
            });
        }

        function setActiveConversation(id) {
            activeConversationId = id;
            displayConversation(id);
            document.querySelectorAll('#conversation-list a').forEach(el => {
                el.classList.toggle('bg-white/10', el.dataset.id == id);
                el.classList.toggle('opacity-100', el.dataset.id == id);
            });
        }

        function formatTimestamp(unixTimestamp) {
            if (!unixTimestamp) return '';
            return new Date(unixTimestamp * 1000).toLocaleString();
        }

        async function displayConversation(id) {
            // Revoke any existing image URLs to prevent memory leaks
            activeObjectURLs.forEach(URL.revokeObjectURL);
            activeObjectURLs = [];

            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            searchInput.value = '';
            searchResultsInfo.textContent = '';

            if (observer) observer.disconnect();
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(sentinel);

            const conversation = await db.conversations.get(id);
            chatTitle.textContent = conversation.title;

            currentMessages = await db.messages.where('conversationId').equals(id).sortBy('timestamp');
            currentRenderIndex = 0;

            // Calculate stats
            if (currentMessages.length > 0) {
                const firstMsgTime = currentMessages[0].timestamp;
                const lastMsgTime = currentMessages[currentMessages.length - 1].timestamp;
                const dateRange = `${new Date(firstMsgTime * 1000).toLocaleDateString()} - ${new Date(lastMsgTime * 1000).toLocaleDateString()}`;
                chatStats.textContent = `${currentMessages.length} messages | ${dateRange}`;
            } else {
                 chatStats.textContent = `0 messages`;
            }

            if (currentMessages.length === 0) {
                messagesContainer.innerHTML = "<p class='text-center text-inherit opacity-75'>No messages found.</p>";
                return;
            }

            renderNextMessageBatch();

            observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    renderNextMessageBatch();
                }
            }, { root: messagesContainer, threshold: 0.1 });
            observer.observe(sentinel);
        }

        function renderNextMessageBatch() {
            if (currentRenderIndex >= currentMessages.length) {
                if (observer) observer.disconnect();
                sentinel.style.display = 'none';
                return;
            }
            sentinel.style.display = 'block';

            const fragment = document.createDocumentFragment();
            const endIndex = Math.min(currentRenderIndex + RENDER_BATCH_SIZE, currentMessages.length);

            const renderPromises = [];
            for (let i = currentRenderIndex; i < endIndex; i++) {
                const msg = currentMessages[i];
                renderPromises.push(createMessageElement(msg));
            }

            Promise.all(renderPromises).then(elements => {
                elements.forEach(el => {
                    if (el) fragment.appendChild(el);
                });
                messagesContainer.insertBefore(fragment, sentinel);
                currentRenderIndex = endIndex;

                messagesContainer.querySelectorAll('pre code:not(pre pre code)').forEach(el => {
                    if(!el.hasAttribute('data-highlighted')) {
                        hljs.highlightElement(el);
                        el.setAttribute('data-highlighted', 'true');
                    }
                });
            });
        }

        async function createMessageElement(msg) {
            let contentHtml = '';
            for (const part of (msg.content || [])) {
                if (part.type === 'text') {
                    contentHtml += marked.parse(part.value);
                } else if (part.type === 'image') {
                    const media = await db.media.get(part.mediaId);
                    if (media && media.blob) {
                        const url = URL.createObjectURL(media.blob);
                        activeObjectURLs.push(url); // Track URL for later revocation
                        contentHtml += `<p><img src="${url}" alt="User uploaded image" class="max-w-xs"></p>`;
                    } else {
                        contentHtml += `<p>[Image not found: ${part.mediaId}]</p>`;
                    }
                }
            }

            const author = msg.author;
            const messageElement = document.createElement('div');
            messageElement.className = 'message-wrapper transition-opacity duration-300';
            const time = formatTimestamp(msg.timestamp);

            if (author === 'user' || author === 'assistant') {
                if (!contentHtml.trim()) return null;
                const isUser = author === 'user';
                const bgColor = isUser ? '' : 'bg-black/20 p-4 rounded-lg';
                messageElement.innerHTML = `
                    <div class="flex items-start gap-4 ${bgColor}">
                        ${isUser ? userIcon : assistantIcon}
                        <div class="flex-1 min-w-0">
                            <div class="prose prose-invert max-w-none prose-p:my-0 prose-pre:my-2 prose-headings:my-2 message-content">${contentHtml}</div>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-xs text-inherit opacity-50">${time}</p>
                                ${!isUser ? `<button class="copy-btn text-xs text-inherit opacity-50 hover:opacity-100 transition-opacity">Copy</button>` : ''}
                            </div>
                        </div>
                    </div>`;
            } else {
                return null; // Simplified: Not rendering tool messages for now
            }
            return messageElement;
        }

        function handleMessageContainerClick(event) {
            const target = event.target;
            if (target.classList.contains('copy-btn')) {
                const messageContentEl = target.closest('.flex-1').querySelector('.message-content');
                if (messageContentEl) {
                    navigator.clipboard.writeText(messageContentEl.innerText).then(() => {
                        target.textContent = 'Copied!';
                        setTimeout(() => { target.textContent = 'Copy'; }, 2000);
                    });
                }
            }
        }

        function performSearch(query) {
            const normalizedQuery = query.trim().toLowerCase();
            const messages = messagesContainer.querySelectorAll('.message-wrapper');
            let matchCount = 0;

            messages.forEach(msg => {
                const contentDiv = msg.querySelector('.message-content');
                if (!contentDiv) return;

                // Remove previous highlights by reverting to original text
                // This is tricky as the original text is gone. A better approach is to re-render.
                // For now, we'll do a simpler highlight/fade.

                const innerHTML = contentDiv.innerHTML;
                const unhighlightedHTML = innerHTML.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
                contentDiv.innerHTML = unhighlightedHTML;


                if (normalizedQuery === '') {
                    msg.style.opacity = '1';
                    return;
                }

                const textContent = contentDiv.textContent || contentDiv.innerText;
                if (textContent.toLowerCase().includes(normalizedQuery)) {
                    msg.style.opacity = '1';
                    matchCount++;

                    // Add new highlight
                    const regex = new RegExp(normalizedQuery.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                    const newHtml = contentDiv.innerHTML.replace(regex, match => `<mark class="search-highlight">${match}</mark>`);
                    contentDiv.innerHTML = newHtml;
                } else {
                    msg.style.opacity = '0.3';
                }
            });

            if (normalizedQuery !== '') {
                searchResultsInfo.textContent = `${matchCount} message(s) found.`;
            } else {
                searchResultsInfo.textContent = '';
            }
        }

        async function performUniversalSearch(query) {
            const normalizedQuery = query.trim().toLowerCase();
            if (normalizedQuery === '') {
                conversationList.classList.remove('hidden');
                universalSearchResults.classList.add('hidden');
                universalSearchResults.innerHTML = '';
                return;
            }
            conversationList.classList.add('hidden');
            universalSearchResults.classList.remove('hidden');
            universalSearchResults.innerHTML = `<p class="p-4 text-inherit opacity-60">Searching...</p>`;

            try {
                // A simple search: find messages containing the query string.
                // For a real full-text search, we'd need a more complex solution.
                const matchingMessages = await db.messages
                    .where('searchText')
                    .startsWithIgnoreCase(normalizedQuery)
                    .toArray();

                if (matchingMessages.length === 0) {
                    universalSearchResults.innerHTML = `<p class="p-4 text-inherit opacity-60">No results found.</p>`;
                    return;
                }

                const convoIds = [...new Set(matchingMessages.map(m => m.conversationId))];
                const convos = await db.conversations.where('id').anyOf(convoIds).toArray();
                const convoMap = new Map(convos.map(c => [c.id, c.title]));

                universalSearchResults.innerHTML = ''; // Clear "Searching..."

                const displayedConvos = new Set();
                matchingMessages.forEach(msg => {
                    if (displayedConvos.has(msg.conversationId)) return;

                    const title = convoMap.get(msg.conversationId);
                    const snippet = createSnippet(msg.searchText, normalizedQuery);

                    const resultEl = document.createElement('a');
                    resultEl.href = '#';
                    resultEl.className = 'block p-3 rounded-md hover:bg-white/10 transition-colors duration-200';
                    resultEl.innerHTML = `<div class="font-bold text-inherit truncate">${title}</div><p class="text-sm text-inherit opacity-60 mt-1">${snippet}</p>`;
                    resultEl.onclick = (e) => {
                        e.preventDefault();
                        setActiveConversation(msg.conversationId);
                        universalSearchInput.value = '';
                        conversationList.classList.remove('hidden');
                        universalSearchResults.classList.add('hidden');
                    };
                    universalSearchResults.appendChild(resultEl);
                    displayedConvos.add(msg.conversationId);
                });

            } catch (error) {
                console.error("Universal search failed:", error);
                universalSearchResults.innerHTML = `<p class="p-4 text-red-400">Search failed.</p>`;
            }
        }

        function createSnippet(content, query) {
            // This can remain as it is for now, will be used by search
            const index = content.toLowerCase().indexOf(query);
            const start = Math.max(0, index - 40);
            const end = Math.min(content.length, index + query.length + 40);
            let snippet = content.substring(start, end).replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
            snippet = snippet.replace(regex, match => `<mark class="search-highlight">${match}</mark>`);
            return (start > 0 ? '...' : '') + snippet + (end < content.length ? '...' : '');
        }

        async function exportConversationsToJson() {
            try {
                loadingModal.classList.remove('hidden');
                loadingModal.classList.add('flex');
                loadingMessage.textContent = 'Exporting all data from database...';

                const conversations = await db.conversations.toArray();
                const messages = await db.messages.toArray();
                const media = await db.media.toArray();

                loadingMessage.textContent = 'Encoding media files...';

                const mediaAsBase64 = {};
                for (const item of media) {
                    const blob = item.blob;
                    const reader = new FileReader();
                    const promise = new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                    mediaAsBase64[item.id] = await promise;
                }

                const exportData = {
                    version: '1.0',
                    platform: 'UCA_EXPORT',
                    exportDate: new Date().toISOString(),
                    data: {
                        conversations,
                        messages,
                        media: mediaAsBase64,
                    }
                };

                loadingMessage.textContent = 'Creating download file...';
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uca_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                showError(`Failed to export data to JSON: ${error.message}`);
                console.error("JSON export error:", error);
            } finally {
                loadingModal.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
